---
    -   hosts: 127.0.0.1
        connection: local
        become: yes
        remote_user: root
        vars:
            GTP5G_DIR_INSTALL : "/root/gtp5g"
            FREE5GC_DIR_INSTALL : "/root/go/src/free5gc"
            UPF_DIR_CONFIG : "/root/go/src/free5gc/NFs/upf/build/config"
            NFS_DIR_CONFIG : "/root/go/src/free5gc/config"
            GO_SRC_DIR : "/root/go/src"
            home_dir: "/root"
            MONGO_URL_CONNECTION: "mongodb://127.0.0.1:27017"
            NRF_IP_ADDRESS: "127.0.0.1"
            NRF_PORT: "29510"
            UDR_IP_ADDRESS: "127.0.0.1"
            UDR_PORT: "29504"
            UDM_IP_ADDRESS: "127.0.0.1"
            UDM_PORT: "29503"
            
            
        tasks:
            - fail: 
                msg: "'internet_network_interface' not found, this parameter is required!"
              when: internet_network_interface == ''

            - name: Environment validation!
              assert:
                that:
                  - ansible_memtotal_mb >= 500
                msg: "Minimum memory requirements in the deployment environment is 4GB! Operation failed!"
    
            - name: Upgrade all apt packages
              apt: upgrade=dist force_apt_get=yes
            
            - name: Install Basic requirements
              apt:
                    name: ['mongodb', 'wget', 'git', 'ca-certificates', 'net-tools', 'gcc', 'cmake', 'autoconf', 'build-essential', 'libtool', 'pkg-config', 'libmnl-dev', 'libyaml-dev']
                    state: present
                    update_cache: yes

            - name: Start Mongo-DB
              shell:  sudo systemctl start mongodb
            
            - name: Remove GTP5G (if exists)
              shell:  sudo rm -rf {{ GTP5G_DIR_INSTALL }}
              ignore_errors: true

            - name: Remove free5GC dir (if exists)
              shell:  sudo rm -rf {{ FREE5GC_DIR_INSTALL }}
              ignore_errors: true

            - name: User-plane Supporting Packages
              shell: go get -u github.com/sirupsen/logrus

            - git: 
                repo: 'https://github.com/PrinzOwO/gtp5g.git'
                dest: "{{ GTP5G_DIR_INSTALL }}"
                version: v0.1.0

            - name: Install linux-headers-5.0.0-23-generic
              shell: sudo apt-get install -y linux-headers-5.0.0-23-generic

            - name  : Run 'Make' into GTP5G
              shell : make
              args:
                chdir: "{{ GTP5G_DIR_INSTALL }}"

            - name  : Install GTP5G
              shell : sudo make install
              args:
                chdir: "{{ GTP5G_DIR_INSTALL }}"
              ignore_errors: true

            - name  : Network Setting 1/3
              shell : sudo sysctl -w net.ipv4.ip_forward=1

            - name  : Network Setting 2/3
              shell : sudo iptables -t nat -A POSTROUTING -o {{ internet_network_interface }} -j MASQUERADE

            - name  : Network Setting 3/3
              shell : sudo systemctl stop ufw

            - name  : Git Clone free5gc
              shell : git clone --recursive -b v3.0.5 -j `nproc` https://github.com/free5gc/free5gc.git
              args:
                chdir: "{{ GO_SRC_DIR }}"

            - name  : Make UPF
              shell : make upf
              args:
                chdir: "{{ FREE5GC_DIR_INSTALL }}"

            - name  : Remove UPF default file config
              shell : rm upfcfg.yaml
              args:
                chdir: "{{ UPF_DIR_CONFIG }}"

            - name  : Build upfcfg.yaml config file
              copy:
                dest: "{{ UPF_DIR_CONFIG }}/upfcfg.yaml"
                content: |
                  info:
                    version: 1.0.0
                    description: UPF configuration
                  
                  configuration:
                    # the kind of log output
                      # debugLevel: how detailed to output, value: trace, debug, info, warn, error, fatal, panic
                      # ReportCaller: enable the caller report or not, value: true or false
                    debugLevel: info
                    ReportCaller: false

                    # The IP list of the N4 interface on this UPF (Can't set to 0.0.0.0)
                    pfcp:
                      - addr: 127.0.0.8
                    # The IP list of the N3/N9 interfaces on this UPF
                    # If there are multiple connection, set addr to 0.0.0.0 or list all the addresses
                    gtpu:
                      - addr: 127.0.0.8
                      # [optional] gtpu.name
                      # - name: upf.5gc.nctu.me
                      # [optional] gtpu.ifname
                      # - ifname: gtpif

                    # The DNN list supported by UPF
                    dnn_list:
                      - dnn: internet # Data Network Name
                        cidr: 60.60.0.0/24 # Classless Inter-Domain Routing for assigned IPv4 pool of UE
                        # [optional] dnn_list[*].natifname
                        # natifname: eth0

            - name  : Remove nrfcfg.yaml default file config
              shell : rm nrfcfg.yaml
              args:
                chdir: "{{ NFS_DIR_CONFIG }}"

            - name  : Build nrfcfg.yaml config file
              copy:
                dest: "{{ NFS_DIR_CONFIG }}/nrfcfg.yaml"
                content: |
                  info:
                    version: 1.0.0
                    description: NRF initial local configuration

                  configuration:
                    MongoDBName: free5gc # database name in MongoDB
                    MongoDBUrl: {{ MONGO_URL_CONNECTION }} # a valid URL of the mongodb
                    sbi: # Service-based interface information
                      scheme: http # the protocol for sbi (http or https)
                      registerIPv4: {{ NRF_IP_ADDRESS }} # IP used to serve NFs or register to another NRF
                      bindingIPv4: {{ NRF_IP_ADDRESS }}  # IP used to bind the service
                      port: {{ NRF_PORT }} # port used to bind the service
                    DefaultPlmnId:
                      mcc: 208 # Mobile Country Code (3 digits string, digit: 0~9)
                      mnc: 93 # Mobile Network Code (2 or 3 digits string, digit: 0~9)
                    serviceNameList: # the SBI services provided by this NRF, refer to TS 29.510
                      - nnrf-nfm # Nnrf_NFManagement service
                      - nnrf-disc # Nnrf_NFDiscovery service

                  # the kind of log output
                    # debugLevel: how detailed to output, value: trace, debug, info, warn, error, fatal, panic
                    # ReportCaller: enable the caller report or not, value: true or false
                  logger:
                    NRF:
                      debugLevel: info
                      ReportCaller: false
                    PathUtil:
                      debugLevel: info
                      ReportCaller: false
                    OpenApi:
                      debugLevel: info
                      ReportCaller: false
                    MongoDBLibrary:
                      debugLevel: info
                      ReportCaller: false

            - name  : Remove udrcfg.yaml default file config
              shell : rm udrcfg.yaml
              args:
                chdir: "{{ NFS_DIR_CONFIG }}"

            - name  : Build udrcfg.yaml config file
              copy:
                dest: "{{ NFS_DIR_CONFIG }}/udrcfg.yaml"
                content: |
                  info:
                    version: 1.0.0
                    description: UDR initial local configuration

                  configuration:
                    sbi: # Service-based interface information
                      scheme: http # the protocol for sbi (http or https)
                      registerIPv4: {{ UDR_IP_ADDRESS }} # IP used to register to NRF
                      bindingIPv4: {{ UDR_IP_ADDRESS }}  # IP used to bind the service
                      port: {{ UDR_PORT }} # port used to bind the service
                    mongodb:
                      name: free5gc # Database name in MongoDB
                      url: {{ MONGO_URL_CONNECTION }} # URL of MongoDB
                    nrfUri: http://{{ NRF_IP_ADDRESS }}:{{ NRF_PORT }} # a valid URI of NRF

                  # the kind of log output
                    # debugLevel: how detailed to output, value: trace, debug, info, warn, error, fatal, panic
                    # ReportCaller: enable the caller report or not, value: true or false
                  logger:
                    UDR:
                      debugLevel: debug
                      ReportCaller: false
                    MongoDBLibrary:
                      debugLevel: info
                      ReportCaller: false
                    PathUtil:
                      debugLevel: info
                      ReportCaller: false
                    OpenApi:
                      debugLevel: info
                      ReportCaller: false

            - name  : Remove udmcfg.yaml default file config
              shell : rm udmcfg.yaml
              args:
                chdir: "{{ NFS_DIR_CONFIG }}"

            - name  : Build udmcfg.yaml config file
              copy:
                dest: "{{ NFS_DIR_CONFIG }}/udmcfg.yaml"
                content: |
                  info:
                    version: 1.0.0
                    description: UDM initial local configuration

                  configuration:
                    serviceNameList: # the SBI services provided by this UDM, refer to TS 29.503
                      - nudm-sdm # Nudm_SubscriberDataManagement service
                      - nudm-uecm # Nudm_UEContextManagement service
                      - nudm-ueau # Nudm_UEAuthenticationManagement service
                      - nudm-ee # Nudm_EventExposureManagement service
                      - nudm-pp # Nudm_ParameterProvisionDataManagement service
                    sbi: # Service-based interface information
                      scheme: http # the protocol for sbi (http or https)
                      registerIPv4: {{ UDM_IP_ADDRESS }} # IP used to register to NRF
                      bindingIPv4: {{ UDM_IP_ADDRESS }}  # IP used to bind the service
                      port: {{ UDM_PORT }} # Port used to bind the service
                      tls: # the local path of TLS key
                        log: free5gc/udmsslkey.log # UDM keylog
                        pem: free5gc/support/TLS/udm.pem # UDM TLS Certificate
                        key: free5gc/support/TLS/udm.key # UDM TLS Private key
                    nrfUri: http://{{ NRF_IP_ADDRESS }}:{{ NRF_PORT }} # a valid URI of NRF

                    # test data set from TS33501-f60 Annex C.4
                    keys:
                      udmProfileAHNPublicKey: 5a8d38864820197c3394b92613b20b91633cbd897119273bf8e4a6f4eec0a650
                      udmProfileAHNPrivateKey: c53c22208b61860b06c62e5406a7b330c2b577aa5558981510d128247d38bd1d
                      udmProfileBHNPublicKey: 0472DA71976234CE833A6907425867B82E074D44EF907DFB4B3E21C1C2256EBCD15A7DED52FCBB097A4ED250E036C7B9C8C7004C4EEDC4F068CD7BF8D3F900E3B4
                      udmProfileBHNPrivateKey: F1AB1074477EBCC7F554EA1C5FC368B1616730155E0041AC447D6301975FECDA

                  # the kind of log output
                    # debugLevel: how detailed to output, value: trace, debug, info, warn, error, fatal, panic
                    # ReportCaller: enable the caller report or not, value: true or false
                  logger:
                    UDM:
                      debugLevel: info
                      ReportCaller: false
                    OpenApi:
                      debugLevel: info
                      ReportCaller: false
                    PathUtil:
                      debugLevel: info
                      ReportCaller: false




#            - name  : my5GCore - Install dependent packages
#              shell : go mod download
#              args:
#                chdir: "{{ FREE5GC_DIR_INSTALL }}"


#            - name  : my5GCore - Compile network function services
#              shell : make all
#              args:
#                chdir: "{{ FREE5GC_DIR_INSTALL }}"

                
