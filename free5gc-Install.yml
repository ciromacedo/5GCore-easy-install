---
    -   hosts: 127.0.0.1
        connection: local
        become: yes
        remote_user: root
        vars:
            GTP5G_DIR_INSTALL : "/root/gtp5g"
            FREE5GC_DIR_INSTALL : "/root/go/src/free5gc"
            UPF_DIR_CONFIG : "/root/go/src/free5gc/NFs/upf/build/config"
            GO_SRC_DIR : "/root/go/src"
            home_dir: "/root"
            
            
        tasks:
            - fail: 
                msg: "'internet_network_interface' not found, this parameter is required!"
              when: internet_network_interface == ''

            - name: Environment validation!
              assert:
                that:
                  - ansible_memtotal_mb >= 500
                msg: "Minimum memory requirements in the deployment environment is 4GB! Operation failed!"
    
            - name: Upgrade all apt packages
              apt: upgrade=dist force_apt_get=yes
            
            - name: Install Basic requirements
              apt:
                    name: ['mongodb', 'wget', 'git', 'ca-certificates', 'net-tools', 'gcc', 'cmake', 'autoconf', 'build-essential', 'libtool', 'pkg-config', 'libmnl-dev', 'libyaml-dev']
                    state: present
                    update_cache: yes

            - name: Start Mongo-DB
              shell:  sudo systemctl start mongodb
            
            - name: Remove GTP5G (if exists)
              shell:  sudo rm -rf {{ GTP5G_DIR_INSTALL }}
              ignore_errors: true

            - name: Remove free5GC dir (if exists)
              shell:  sudo rm -rf {{ FREE5GC_DIR_INSTALL }}
              ignore_errors: true

            - name: User-plane Supporting Packages
              shell: go get -u github.com/sirupsen/logrus

            - git: 
                repo: 'https://github.com/PrinzOwO/gtp5g.git'
                dest: "{{ GTP5G_DIR_INSTALL }}"
                version: v0.1.0

            - name: Install linux-headers-5.0.0-23-generic
              shell: sudo apt-get install -y linux-headers-5.0.0-23-generic

            - name  : Run 'Make' into GTP5G
              shell : make
              args:
                chdir: "{{ GTP5G_DIR_INSTALL }}"

            - name  : Install GTP5G
              shell : sudo make install
              args:
                chdir: "{{ GTP5G_DIR_INSTALL }}"
              ignore_errors: true

            - name  : Network Setting 1/3
              shell : sudo sysctl -w net.ipv4.ip_forward=1

            - name  : Network Setting 2/3
              shell : sudo iptables -t nat -A POSTROUTING -o {{ internet_network_interface }} -j MASQUERADE

            - name  : Network Setting 3/3
              shell : sudo systemctl stop ufw

            - name  : Git Clone free5gc
              shell : git clone --recursive -b v3.0.5 -j `nproc` https://github.com/free5gc/free5gc.git
              args:
                chdir: "{{ GO_SRC_DIR }}"

            - name  : Make UPF
              shell : make upf
              args:
                chdir: "{{ FREE5GC_DIR_INSTALL }}"

            - name  : Remove UPF default file config
              shell : rm upfcfg.yaml
              args:
                chdir: "{{ UPF_DIR_CONFIG }}"


            - name  : Build upfcfg.yaml config file
              copy:
                dest: "{{ UPF_DIR_CONFIG }}/upfcfg.yaml"
                content: |
                  info:
                    version: 1.0.0
                    description: UPF configuration
                  
                  configuration:
                    # the kind of log output
                      # debugLevel: how detailed to output, value: trace, debug, info, warn, error, fatal, panic
                      # ReportCaller: enable the caller report or not, value: true or false
                    debugLevel: info
                    ReportCaller: false

                    # The IP list of the N4 interface on this UPF (Can't set to 0.0.0.0)
                    pfcp:
                      - addr: 127.0.0.8
                    # The IP list of the N3/N9 interfaces on this UPF
                    # If there are multiple connection, set addr to 0.0.0.0 or list all the addresses
                    gtpu:
                      - addr: 127.0.0.8
                      # [optional] gtpu.name
                      # - name: upf.5gc.nctu.me
                      # [optional] gtpu.ifname
                      # - ifname: gtpif

                    # The DNN list supported by UPF
                    dnn_list:
                      - dnn: internet # Data Network Name
                        cidr: 60.60.0.0/99 # Classless Inter-Domain Routing for assigned IPv4 pool of UE
                        # [optional] dnn_list[*].natifname
                        # natifname: eth0


#            - name  : my5GCore - Install dependent packages
#              shell : go mod download
#              args:
#                chdir: "{{ FREE5GC_DIR_INSTALL }}"


#            - name  : my5GCore - Compile network function services
#              shell : make all
#              args:
#                chdir: "{{ FREE5GC_DIR_INSTALL }}"

                
